<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght{400;500;600;700}&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 100vw;
            overflow-x: auto;
        }
        canvas {
            display: block;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .download-button {
            background-color: #2563eb;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            text-align: center;
        }
        .download-button:hover {
            background-color: #1e40af;
        }
        .download-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="flex flex-col items-center p-4 bg-white rounded-xl shadow-lg mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">Timetable Viewer</h1>
        <p class="text-gray-600 mb-6 text-center">Select a Course OR a Lecturer to view the weekly timetable.</p>
        
        <div class="w-full max-w-2xl flex flex-col items-center space-y-4">
            
            <!-- Selector Container -->
            <div class="w-full flex flex-col sm:flex-row gap-4">
                <!-- Course Selector -->
                <div class="w-full sm:w-1/2">
                    <label for="course-select" class="block text-gray-700 text-sm font-bold mb-2">By Course:</label>
                    <select id="course-select" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline transition duration-200">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <!-- Lecturer Selector -->
                <div class="w-full sm:w-1/2">
                    <label for="lecturer-select" class="block text-gray-700 text-sm font-bold mb-2">By Lecturer:</label>
                    <select id="lecturer-select" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline transition duration-200">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
            
            <!-- Button Row -->
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full pt-2">
                <button id="download-btn" class="download-button shadow-lg w-full sm:w-1/2" disabled>
                    Download Timetable PDF
                </button>
                <button id="download-attendance-btn" class="download-button shadow-lg w-full sm:w-1/2 bg-green-600 hover:bg-green-700" disabled>
                    Download Attendance Card
                </button>
            </div>
        </div>
    </div>

    <div id="timetable-display" class="hidden">
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <h2 id="timetable-title" class="text-2xl font-bold text-gray-800 mb-4 text-center"></h2>
            <div id="timetable-container" class="container">
                <canvas id="timetable-canvas" width="1000" height="600"></canvas>
            </div>
        </div>
    </div>

    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const courseSelect = document.getElementById('course-select');
            const lecturerSelect = document.getElementById('lecturer-select');
            const downloadBtn = document.getElementById('download-btn');
            const downloadAttendanceBtn = document.getElementById('download-attendance-btn');
            const timetableDisplay = document.getElementById('timetable-display');
            const timetableTitle = document.getElementById('timetable-title');
            const canvas = document.getElementById('timetable-canvas');
            const ctx = canvas.getContext('2d');
            
            let timetableData = [];
            let currentSelection = { type: null, value: null }; 

            // Drawing constants for Canvas
            const timeHeaderWidth = 80;
            const dayHeaderHeight = 40;
            const timeSlots = ['9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'];
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const minutesInSlot = 30;
            const eng_maths = ["English","Maths"];

            // --- Custom Color Palette for Lecturers ---
            // Indices: 0-2 (Dark Blue), 3-5 (Light Blue), 6-7 (Purple), 8-9 (Light Purple)
            const lecturerPalette = [
                '#1d4ed8','#2563eb','#3b82f6', // Darker Blues
                '#60a5fa','#93c5fd','#bfdbfe', // Lighter Blues
                '#9333ea','#a855f7',           // Darker Purples
                '#c084fc','#d8b4fe'            // Lighter Purples
            ];

            function parseTime(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            function convert12hrTo24hr(timeStr) {
                let [hours, minutes] = timeStr.split(':').map(Number);
                if (hours >= 1 && hours <= 8) {
                    hours += 12;
                }
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }

            // Helper to determine color based on Course Name (minus group)
            function getCourseColorInfo(fullCourseString) {
                // Remove group (everything after the last hyphen)
                // e.g., "S118ED-Y1-G1" -> "S118ED-Y1"
                const lastDash = fullCourseString.lastIndexOf('-');
                const baseCourse = lastDash > -1 ? fullCourseString.substring(0, lastDash) : fullCourseString;
                
                // Generate a hash from the baseCourse string
                let hash = 0;
                for (let i = 0; i < baseCourse.length; i++) {
                    hash = baseCourse.charCodeAt(i) + ((hash << 5) - hash);
                }
                
                // Map hash to palette index
                const index = Math.abs(hash) % lecturerPalette.length;
                const bgColor = lecturerPalette[index];

                // Determine readable text color
                // Palette indices 3, 4, 5, 8, 9 are light colors -> Use Dark Text
                // Palette indices 0, 1, 2, 6, 7 are dark colors -> Use White Text
                const isLight = [3, 4, 5, 8, 9].includes(index);
                const textColor = isLight ? '#1f2937' : '#ffffff'; // Dark Gray or White

                return { bgColor, textColor };
            }

            // --- CANVAS DRAWING FUNCTION ---
            function drawTimetable(type, value) {
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const timeCellWidth = (canvas.width - timeHeaderWidth) / (timeSlots.length * 2);
                const dayCellHeight = (canvas.height - dayHeaderHeight) / days.length;

                // Draw headers
                ctx.fillStyle = '#1f2937';
                ctx.font = '600 14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                timeSlots.forEach((slot, index) => {
                    ctx.save();
                    ctx.translate(timeHeaderWidth + index * timeCellWidth * 2 + timeCellWidth, dayHeaderHeight / 2);
                    ctx.fillStyle = '#1f2937';
                    ctx.fillText(slot, 0, 0);
                    ctx.restore();
                });
                
                ctx.fillStyle = '#4b5563';
                ctx.font = '600 14px Inter, sans-serif';
                ctx.textAlign = 'left';
                days.forEach((day, index) => {
                    ctx.save();
                    ctx.translate(1, dayHeaderHeight + index * dayCellHeight + dayCellHeight / 2);
                    ctx.fillStyle = '#4b5563';
                    ctx.fillText(day, 0, 0);
                    ctx.restore();
                });

                // Draw grid lines
                ctx.strokeStyle = '#e5e7eb';
                for (let i = 0; i <= days.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(timeHeaderWidth, dayHeaderHeight + i * dayCellHeight);
                    ctx.lineTo(canvas.width, dayHeaderHeight + i * dayCellHeight);
                    ctx.stroke();
                }
                for (let i = 0; i < timeSlots.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(timeHeaderWidth + i * timeCellWidth * 2, dayHeaderHeight);
                    ctx.lineTo(timeHeaderWidth + i * timeCellWidth * 2, canvas.height);
                    ctx.stroke();
                }

                // Filter and Draw Events
                const relevantEvents = timetableData.filter(event => event[type] === value);

                relevantEvents.forEach(event => {
                    const timeParts = event.time.split(' - ');
                    const startTime24hr = convert12hrTo24hr(timeParts[0]);
                    const formattedTime = `${startTime24hr} - ${convert12hrTo24hr(timeParts[1])}`;

                    const startTimeMinutes = parseTime(startTime24hr);
                    const dayIndex = parseInt(event.day) - 1;

                    if (dayIndex >= 0 && dayIndex < days.length) {
                        const startMinutesFrom9am = startTimeMinutes - parseTime('9:00');
                        const startSlotIndex = startMinutesFrom9am / minutesInSlot;
                        const durationInMinutes = event.length * 60;
                        const durationInSlots = durationInMinutes / minutesInSlot;

                        const x = timeHeaderWidth + startSlotIndex * timeCellWidth;
                        const y = dayHeaderHeight + dayIndex * dayCellHeight;
                        const width = durationInSlots * timeCellWidth;
                        const height = dayCellHeight;

                        // --- COLOR LOGIC ---
                        let rectColor, textColor;

                        if (type === 'lecturer') {
                            const colorInfo = getCourseColorInfo(event.course);
                            rectColor = colorInfo.bgColor;
                            textColor = colorInfo.textColor;
                            ctx.strokeStyle = rectColor; // Match border to fill
                        } else {
                            // Standard Course View Logic
                            if (eng_maths.includes(event.unit)) {
                                 rectColor = '#45913d'; 
                                 ctx.strokeStyle = '#367a2e';
                            } else {
                                 rectColor = '#1e40af'; 
                                 ctx.strokeStyle = '#2563eb';
                            }
                            textColor = '#ffffff';
                        }
                        
                        ctx.fillStyle = rectColor;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.roundRect(x + 2, y + 2, width - 4, height - 4, 8);
                        ctx.fill();
                        ctx.stroke();

                        // Draw event text
                        ctx.fillStyle = textColor;
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'top';
                        
                        const textX = x + 10;
                        const textY = y + 8;
                        const lineHeight = 15;

                        if (type === 'lecturer') {
                            // --- LECTURER VIEW LAYOUT ---
                            ctx.font = '600 12px Inter, sans-serif'; 
                            ctx.fillText(event.course, textX, textY);
                            ctx.font = '600 11px Inter, sans-serif';
                            ctx.fillText(event.unit, textX, textY + lineHeight);
                            ctx.font = '500 11px Inter, sans-serif';
                            ctx.fillText(formattedTime, textX, textY + lineHeight * 2);
                            ctx.fillText(`Room: ${event.room}`, textX, textY + lineHeight * 3);
                        } else {
                            // --- COURSE VIEW LAYOUT ---
                            ctx.font = '600 13px Inter, sans-serif';
                            ctx.fillText(event.unit, textX, textY);
                            ctx.font = '500 11px Inter, sans-serif';
                            ctx.fillText(formattedTime, textX, textY + lineHeight + 2);
                            ctx.fillText(`Lecturer: ${event.lecturer}`, textX, textY + lineHeight * 2 + 2);
                            ctx.fillText(`Room: ${event.room}`, textX, textY + lineHeight * 3 + 2);
                        }
                    }
                });

                timetableTitle.textContent = `${type === 'lecturer' ? 'Lecturer' : 'Course'}: ${value}`;
                timetableDisplay.classList.remove('hidden');
                downloadBtn.disabled = false;
                downloadAttendanceBtn.disabled = false;
            }

            // --- PDF DRAWING HELPER FUNCTION (Maintains standard black/white for attendance) ---
            function drawAttendanceTimetable(doc, type, value, yOffset) {
                const margin = 10;
                const docWidth = doc.internal.pageSize.getWidth();
                const cardWidth = docWidth - 2 * margin; 
                const cardHeight = 120; 

                let currentY = yOffset;

                // Header Info
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(50, 50, 50);

                const headerLineHeight = 6;
                doc.setFont(undefined, 'bold');
                
                const label = type === 'lecturer' ? "Lecturer Name" : "Course ID";
                doc.text(`${label}: ${value}`, margin, currentY);
                
                doc.setFont(undefined, 'normal');
                currentY += headerLineHeight;
                doc.text(`ID: ______________`, margin, currentY);
                doc.text(`Name: ______________`, margin+(docWidth / 4)-15, currentY);
                doc.text(`Reason: ________________________`, margin+(docWidth*2/4)-20, currentY);
                doc.text(`Date: ___________`, margin+(docWidth*3/4), currentY);
                currentY += headerLineHeight - 1; 

                const gridYStart = currentY;
                const dayHeaderHeight = 8; 
                const timeSlots = ['9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'];
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const timeHeaderWidth = 20;
                
                const dayCellHeight = (cardHeight - dayHeaderHeight) / days.length; 
                const timeCellWidth = (cardWidth - timeHeaderWidth) / (timeSlots.length * 2);

                // Draw Grid
                doc.setDrawColor(0);
                doc.setLineWidth(0.5);
                doc.rect(margin, gridYStart, cardWidth, cardHeight);

                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('Day', margin + timeHeaderWidth / 2, gridYStart + dayHeaderHeight / 2, { align: 'center' });
                doc.setLineWidth(0.2);
                
                days.forEach((day, index) => {
                    const y = gridYStart + dayHeaderHeight + index * dayCellHeight;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(day.substring(0, 3), margin + timeHeaderWidth / 2, y + dayCellHeight / 2, { align: 'center' });
                    doc.line(margin, y, margin + cardWidth, y); 
                });
                
                doc.line(margin + timeHeaderWidth, gridYStart, margin + timeHeaderWidth, gridYStart + cardHeight);

                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                timeSlots.forEach((slot, index) => {
                    const x = margin + timeHeaderWidth + index * timeCellWidth * 2 + timeCellWidth;
                    doc.text(slot, x, gridYStart + dayHeaderHeight / 2, { align: 'center' });
                    const xHourLine = margin + timeHeaderWidth + index * timeCellWidth * 2;
                    doc.line(xHourLine, gridYStart, xHourLine, gridYStart + cardHeight);
                });
                doc.line(margin, gridYStart + dayHeaderHeight, margin + cardWidth, gridYStart + dayHeaderHeight);


                // Draw Events
                const minutesInSlot = 30;
                const relevantEvents = timetableData.filter(event => event[type] === value);

                relevantEvents.forEach(event => {
                    const timeParts = event.time.split(' - ');
                    const startTime24hr = convert12hrTo24hr(timeParts[0]);
                    const startTimeMinutes = parseTime(startTime24hr);
                    const dayIndex = parseInt(event.day) - 1;

                    if (dayIndex >= 0 && dayIndex < days.length) {
                        const startMinutesFrom9am = startTimeMinutes - parseTime('9:00');
                        const startSlotIndex = startMinutesFrom9am / minutesInSlot;
                        const durationInMinutes = event.length * 60;
                        const durationInSlots = durationInMinutes / minutesInSlot;

                        const x = margin + timeHeaderWidth + startSlotIndex * timeCellWidth;
                        const y = gridYStart + dayHeaderHeight + dayIndex * dayCellHeight;
                        const width = durationInSlots * timeCellWidth;
                        const height = dayCellHeight;

                        doc.setDrawColor(30, 30, 30);
                        doc.setFillColor(255, 255, 255); 
                        doc.setLineWidth(0.4);
                        doc.rect(x + 0.5, y + 0.5, width - 1, height - 1, 'FD');

                        // Unit Text inside PDF Box
                        doc.setTextColor(30, 30, 30);
                        doc.setFont(undefined, 'bold');
                        
                        const textMarginX = 1; 
                        const textMarginY = 2.5;
                        
                        if (type === 'lecturer') {
                            doc.setFontSize(6);
                            doc.text(event.course, x + textMarginX, y + textMarginY, { align: 'left', baseline: 'top' });
                            doc.text(event.unit, x + textMarginX, y + textMarginY + 3, { align: 'left', baseline: 'top' });
                        } else {
                            doc.setFontSize(7);
                            doc.text(event.unit, x + textMarginX, y + textMarginY, { align: 'left', baseline: 'top' });
                        }
                    }
                });
            }

            // Function to generate the Visual Attendance Card PDF
            function generateAttendanceCardPDF(type, value) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4'); 
                drawAttendanceTimetable(doc, type, value, 10);
                drawAttendanceTimetable(doc, type, value, 160); 
                doc.save(`attendance-${type}-${value}.pdf`);
            }

            // Function to handle the CSV file content
            function processCSV(csvString) {
                const rows = csvString.trim().split('\n').map(row => row.split('\t').map(cell => cell.replace(/"/g, '')));
                const headers = rows[0];
                timetableData = rows.slice(1).map(row => {
                    const event = {};
                    headers.forEach((header, index) => {
                        event[header.trim()] = row[index] ? row[index].trim() : '';
                    });
                    event.length = parseFloat(event.length);
                    return event;
                });
                
                const courses = [...new Set(timetableData.map(event => event.course))].sort();
                courseSelect.innerHTML = '<option value="">Select a course...</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseSelect.appendChild(option);
                });

                const lecturers = [...new Set(timetableData.map(event => event.lecturer))]
                    .filter(l => l && l.toLowerCase() !== 'none')
                    .sort();
                lecturerSelect.innerHTML = '<option value="">Select a lecturer...</option>';
                lecturers.forEach(lecturer => {
                    const option = document.createElement('option');
                    option.value = lecturer;
                    option.textContent = lecturer;
                    lecturerSelect.appendChild(option);
                });
            }

            // CSV CONTENT
            const csvContent = `course	unit	day	time	length	lecturer	room
S104-G1	U4	2	9:00 - 10:30	1.5	Batoul	SP215
S104-G1	TUT	2	11:00 - 12:00	1	Batoul	SP309
S104-G1	U19	2	1:00 - 2:30	1.5	Batoul	SP311
S104-G1	U12	4	1:15 - 2:45	1.5	Batoul	SP311
S104-G1	English	3	9:00 - 10:30	1.5	None	TBA
S104-G1	Maths	3	10:45 - 12:15	1.5	None	TBA
S104-G1	U1	3	1:15 - 2:45	1.5	Batoul	SP007
S104-G1	English	4	9:00 - 10:30	1.5	None	TBA
S104-G1	Maths	4	10:45 - 12:15	1.5	None	TBA
S104-G1	U3	5	1:15 - 2:45	1.5	Saimah	SP312
S104-G1	WS	4	3:00 - 4:00	1	Alex	SP308
S104-G1	U2	5	10:45 - 12:15	1.5	Alex	SP308
S104-G1	U8	2	2:45 - 4:15	1.5	Alex	SP312
S118ED-Y1-G1	U14	3	9:00 - 10:30	1.5	Alex	SP301
S118ED-Y1-G1	TUT	4	2:15 - 3:15	1	Saimah	SP310
S118ED-Y1-G1	U4	2	9:00 - 10:30	1.5	Amran	SP307
S118ED-Y1-G1	U9	4	9:00 - 10:30	1.5	Mubasshira	SP308
S118ED-Y1-G1	English	5	9:00 - 10:30	1.5	None	SP208
S118ED-Y1-G1	U2/4	3	1:15 - 2:45	1.5	Dalia	SP306
S118ED-Y1-G1	English	2	11:00 - 12:30	1.5	Paula	SP208
S118ED-Y1-G1	U14	5	1:15 - 2:15	1	Alex	SP308
S118ED-Y1-G1	U4	4	1:00 - 2:00	1	Saimah	SP310
S118ED-Y1-G1	U14	4	11:00 - 12:00	1	John	SP306
S118ED-Y1-G1	U4	5	11:00 - 12:00	1	Amran	SP307
S118ED-Y1-G1	U2/4	5	2:30 - 3:30	1	Amran	SP307
S118ED-Y1-G1	U9	2	2:00 - 3:00	1	Sadik	SP310
S118ED-Y1-G1	U9	3	11:00 - 12:00	1	Sadik	SP310
S118ED-Y2-G1	Maths	1	9:00 - 10:30	1.5	Khadija	SP201
S118ED-Y2-G1	U7/6	2	11:00 - 12:30	1.5	Maarya	SP301
S118ED-Y2-G1	U5C/14	3	9:00 - 10:45	1.75	John	SP306
S118ED-Y2-G1	U5B/20	1	3:00 - 4:00	1	Maarya	SP301
S118ED-Y2-G1	U5B/20	4	9:00 - 10:45	1.75	Maarya	SP301
S118ED-Y2-G1	U5C/14	1	1:45 - 2:45	1	John	SP306
S118ED-Y2-G1	U9	2	9:00 - 10:45	1.75	Mubasshira	SP308
S118ED-Y2-G1	Maths	3	11:00 - 12:30	1.5	Khadija	SP201
S118ED-Y2-G1	U5P/21	3	1:15 - 2:15	1	Maarya	SP301
S118ED-Y2-G1	U7/6	2	1:30 - 3:00	1.5	Saimah	SP308
S118ED-Y2-G1	TUT	4	11:00 - 12:00	1	Saimah	SP312
S118ED-Y2-G1	U5P/21	1	11:00 - 12:45	1.75	Steven	SP309
S118ED-Y1-G2	U9	1	9:00 - 10:00	1	Sadik	SP312
S118ED-Y1-G2	U/4	4	2:45 - 3:45	1	Amran	SP307
S118ED-Y1-G2	U2/4	1	1:00 - 2:30	1.5	Dalia	SP312
S118ED-Y1-G2	U4	4	1:00 - 2:30	1.5	Amran	SP307
S118ED-Y1-G2	U4	2	10:00 - 11:00	1	Saimah	SP309
S118ED-Y1-G2	TUT	2	11:00 - 12:00	1	Mubasshira	SP308
S118ED-Y1-G2	U14	4	11:00 - 12:00	1	Alex	SP310
S118ED-Y1-G2	U9	1	10:00 - 11:00	1	Sadik	SP312
S118ED-Y1-G2	Maths	3	9:00 - 10:30	1.5	None	TBA
S118ED-Y1-G2	U14	2	2:00 - 3:00	1	John	SP306
S118ED-Y1-G2	Maths	4	9:00 - 10:30	1.5	None	TBA
S118ED-Y1-G2	U14	1	2:45 - 4:15	1.5	John	SP306
S118ED-Y1-G2	U9	3	11:00 - 12:30	1.5	Mubasshira	SP308
S118ED-Y1-G2	U2/4	2	3:15 - 4:15	1	Amran	SP307
S118ED-Y2-G2	U5C/14	2	9:00 - 10:45	1.75	John	SP306
S118ED-Y2-G2	U5C/14	2	1:00 - 2:00	1	John	SP306
S118ED-Y2-G2	U9	3	9:00 - 10:45	1.75	Mubasshira	SP308
S118ED-Y2-G2	U5B/20	3	11:00 - 12:00	1	Maarya	SP301
S118ED-Y2-G2	U7/6	3	1:00 - 2:30	1.5	Saimah	SP011
S118ED-Y2-G2	U7/6	2	2:15 - 3:45	1.5	Maarya	SP301
S118ED-Y2-G2	TUT	4	11:00 - 12:00	1	Dalia	SP311
S118ED-Y2-G2	U5P/21	4	1:45 - 3:30	1.75	Steven	SP309
S118ED-Y2-G2	U5B/20	1	9:00 - 10:45	1.75	Maarya	SP301
S118ED-Y2-G2	U5P/21	1	1:00 - 2:00	1	Maarya	SP301
S118ED-Y1-G3	U14	1	9:00 - 10:30	1.5	John	SP306
S118ED-Y1-G3	U2/4	3	10:45 - 12:15	1.5	Dalia	SP312
S118ED-Y1-G3	U9	1	1:30 - 3:00	1.5	Mubasshira	SP308
S118ED-Y1-G3	U4	2	1:15 - 2:45	1.5	Amran	SP307
S118ED-Y1-G3	TUT	2	11:15 - 12:15	1	Sadik	SP312
S118ED-Y1-G3	U4	2	9:00 - 10:00	1	Saimah	SP309
S118ED-Y1-G3	U9	3	1:00 - 2:00	1	Sadik	SP312
S118ED-Y1-G3	U9	3	9:00 - 10:00	1	Sadik	SP312
S118ED-Y1-G3	U4	3	2:00 - 3:00	1	Amran	SP307
S118ED-Y1-G3	U2/4	1	11:15 - 12:15	1	Amran	SP307
S118ED-Y1-G3	U14	4	10:00 - 11:00	1	Alex	SP310
S118ED-Y1-G3	U14	4	1:00 - 2:00	1	John	SP306
S118ED-Y2-G3	U9	1	9:00 - 10:45	1.75	Mubasshira	SP308
S118ED-Y2-G3	U5P/21	1	11:00 - 12:00	1	Maarya	SP301
S118ED-Y2-G3	U5B/20	3	9:00 - 10:00	1	Batoul	SP007
S118ED-Y2-G3	U5C/14	3	11:00 - 12:00	1	John	SP306
S118ED-Y2-G3	U5P/21	4	9:00 - 10:45	1.75	Steven	SP309
S118ED-Y2-G3	TUT	4	11:00 - 12:00	1	Mubasshira	SP308
S118ED-Y2-G3	U5B/20	4	1:00 - 2:45	1.75	Maarya	SP301
S118ED-Y2-G3	U7/6	5	9:00 - 10:30	1.5	Saimah	SP312
S118ED-Y2-G3	U7/6	5	10:45 - 12:15	1.5	Maarya	SP301
S118ED-Y2-G3	U5C/14	5	1:15 - 3:00	1.75	John	SP306
S118ED-Y1-G4	U2/4	5	1:00 - 2:00	1	Amran	SP307
S118ED-Y1-G4	U9	2	10:00 - 11:00	1	Sadik	SP312
S118ED-Y1-G4	U9	2	9:00 - 10:00	1	Sadik	SP312
S118ED-Y1-G4	TUT	2	11:15 - 12:15	1	Amran	SP307
S118ED-Y1-G4	U2/4	2	1:00 - 2:30	1.5	Dalia	SP312
S118ED-Y1-G4	U3C/14	5	9:00 - 10:30	1.5	Alex	SP308
S118ED-Y1-G4	U4	1	1:15 - 2:45	1.5	Amran	SP307
S118ED-Y1-G4	U3B/10	3	1:30 - 3:00	1.5	Mubasshira	SP308
S118ED-Y1-G4	U4	1	3:00 - 4:00	1	Amran	SP307
S118ED-Y1-G4	U1C/14	5	11:00 - 12:00	1	John	SP306
S118ED-Y1-G4	U14	5	2:15 - 3:15	1	Alex	SP308
S118ED-Y1-G4	U4	3	9:00 - 10:00	1	Saimah	SP208
S118ED-Y1-G4	Maths	1	9:00 - 10:45	1.75	Khadija	SP201
S118ED-Y1-G4	Maths	3	11:00 - 12:30	1.5	Khadija	SP201
S118ED-Y2-G4	U5B/20	2	9:00 - 10:45	1.75	Maarya	SP301
S118ED-Y2-G4	U5P/21	5	1:15 - 2:15	1	Maarya	SP301
S118ED-Y2-G4	U5P/21	3	9:00 - 10:45	1.75	Steven	SP309
S118ED-Y2-G4	U5B/20	3	11:00 - 12:00	1	Batoul	SP108
S118ED-Y2-G4	U5C/14	4	9:00 - 10:45	1.75	John	SP306
S118ED-Y2-G4	TUT	4	11:00 - 12:00	1	Maarya	SP301
S118ED-Y2-G4	U9	4	1:00 - 2:45	1.75	Mubasshira	SP201
S118ED-Y2-G4	U7/6	5	9:00 - 10:30	1.5	Maarya	SP301
S118ED-Y2-G4	U7/6	5	10:45 - 12:15	1.5	Saimah	SP312
S118ED-Y2-G4	U5C/14	2	11:00 - 12:00	1	John	SP306
S118ED-Y1-G5	U2/4	1	9:00 - 10:30	1.5	Dalia	SP310
S118ED-Y1-G5	U3B/10	1	11:00 - 12:30	1.5	Mubasshira	SP308
S118ED-Y1-G5	U4	3	10:30 - 12:00	1.5	Amran	SP307
S118ED-Y1-G5	U9	1	2:00 - 3:00	1	Sadik	SP310
S118ED-Y1-G5	U4	3	1:00 - 2:00	1	Amran	SP307
S118ED-Y1-G5	TUT	2	11:00 - 12:00	1	Dalia	SP310
S118ED-Y1-G5	U4	4	10:00 - 11:00	1	Saimah	SP312
S118ED-Y1-G5	U1C/14	2	1:00 - 2:00	1	Alex	SP309
S118ED-Y1-G5	U2/4	4	11:00 - 12:00	1	Amran	SP307
S118ED-Y1-G5	U9	3	2:00 - 3:00	1	Sadik	SP312
S118ED-Y1-G5	U3C/14	4	1:00 - 2:30	1.5	Alex	SP308
S118ED-Y1-G5	U1C/14	4	2:45 - 3:45	1	John	SP306
S118ED-Y1-G6	U4	1	9:00 - 10:30	1.5	Amran	SP307
S118ED-Y1-G6	U1C/14	1	11:00 - 12:00	1	John	SP306
S118ED-Y1-G6	U9	2	1:00 - 2:00	1	Sadik	SP310
S118ED-Y1-G6	U1C/14	2	9:00 - 10:00	1	Alex	SP310
S118ED-Y1-G6	TUT	2	11:00 - 12:00	1	Alex	SP113
S118ED-Y1-G6	U9	1	1:00 - 2:00	1	Sadik	SP310
S118ED-Y1-G6	U4	3	9:00 - 10:00	1	Amran	SP307
S118ED-Y1-G6	U4	3	11:00 - 12:00	1	Saimah	SP309
S118ED-Y1-G6	U3C/14	3	1:00 - 2:30	1.5	Alex	SP309
S118ED-Y1-G6	U3B/10	4	10:30 - 12:00	1.5	Batoul	SP214
S118ED-Y1-G6	U2/4	4	9:00 - 10:00	1	Amran	SP307
S118ED-Y1-G6	U2/4	4	1:00 - 2:30	1.5	Dalia	SP312
 
`;

            processCSV(csvContent);

            // Event listener for Course selection
            courseSelect.addEventListener('change', (e) => {
                const selectedCourse = e.target.value;
                if (selectedCourse) {
                    lecturerSelect.value = ""; // Reset lecturer select
                    currentSelection = { type: 'course', value: selectedCourse };
                    drawTimetable('course', selectedCourse);
                } else {
                    hideTimetable();
                }
            });

            // Event listener for Lecturer selection
            lecturerSelect.addEventListener('change', (e) => {
                const selectedLecturer = e.target.value;
                if (selectedLecturer) {
                    courseSelect.value = ""; // Reset course select
                    currentSelection = { type: 'lecturer', value: selectedLecturer };
                    drawTimetable('lecturer', selectedLecturer);
                } else {
                    hideTimetable();
                }
            });

            function hideTimetable() {
                timetableDisplay.classList.add('hidden');
                downloadBtn.disabled = true;
                downloadAttendanceBtn.disabled = true;
                currentSelection = { type: null, value: null };
            }

            // Download Timetable PDF
            downloadBtn.addEventListener('click', () => {
                if(!currentSelection.value) return;

                const doc = new window.jspdf.jsPDF('l', 'mm', 'a4'); 
                const canvasImage = canvas.toDataURL('image/png', 1.0);
                
                // Add Title to PDF
                const pdfWidth = doc.internal.pageSize.getWidth();
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(30, 30, 30);
                const titleText = `${currentSelection.type === 'lecturer' ? 'Lecturer' : 'Course'}: ${currentSelection.value}`;
                doc.text(titleText, pdfWidth / 2, 15, { align: 'center' });

                // Add Image (shifted down to make room for title)
                const startY = 25; 
                const imgWidth = 277; // Slightly less than 297 to allow margins
                const pageHeight = 210; 
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = startY;

                doc.addImage(canvasImage, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - startY);

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(canvasImage, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const filename = `timetable-${currentSelection.type}-${currentSelection.value}.pdf`;
                doc.save(filename);
            });

            // Download Attendance Card
            downloadAttendanceBtn.addEventListener('click', () => {
                if(currentSelection.value) {
                    generateAttendanceCardPDF(currentSelection.type, currentSelection.value);
                }
            });
        });
    </script>
</body>
</html>



